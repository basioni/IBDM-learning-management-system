/*! BuddyDrive - v2.1.0 - 2017-04-11 11:17:17 PM UTC - https://github.com/mrpritchett/buddydrive/ */
window.wp=window.wp||{},window.buddydrive=window.buddydrive||{},function(a,b){"undefined"!=typeof BuddyDrive_Upgrader&&(_.extend(buddydrive,_.pick(wp,"Backbone","ajax","template")),buddydrive.Models=buddydrive.Models||{},buddydrive.Collections=buddydrive.Collections||{},buddydrive.Views=buddydrive.Views||{},buddydrive.Upgrader={start:function(){this.tasks=new buddydrive.Collections.Tasks,this.completed=!1;var a=new buddydrive.Views.Upgrader({collection:this.tasks});a.inject("#buddydrive-upgrader"),this.setUpTasks()},setUpTasks:function(){var a=this;_.each(BuddyDrive_Upgrader.tasks,function(b,c){_.isObject(b)&&a.tasks.add({id:b.action_id,order:c,message:b.message,count:b.count,done:0,active:!1})})}},buddydrive.Collections.Tasks=Backbone.Collection.extend({proceed:function(a){return a=a||{},a.context=this,a.data=a.data||{},a.data=_.extend(a.data,{action:"buddydrive_upgrader",_buddydrive_nonce:BuddyDrive_Upgrader.nonce}),buddydrive.ajax.send(a)}}),buddydrive.View=buddydrive.Backbone.View.extend({inject:function(a){this.render(),b(a).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),buddydrive.Views.Upgrader=buddydrive.View.extend({tagName:"div",initialize:function(){this.views.add(new buddydrive.View({tagName:"ul",id:"buddydrive-tasks"})),this.collection.on("add",this.injectTask,this),this.collection.on("change:active",this.manageQueue,this),this.collection.on("change:done",this.manageQueue,this)},taskSuccess:function(a){var c,d,e;a.done&&a.action_id&&(c=this.get(a.action_id),c.set("done",Number(a.done)+Number(c.get("done"))),Number(c.get("count"))===Number(c.get("done"))&&(c.set("active",!1),d=Number(c.get("order"))+1,e=this.findWhere({order:d}),_.isObject(e)?e.set("active",!0):b(".dashboard_page_buddydrive-upgrade #message").removeClass("buddydrive-hide")))},taskError:function(a){if(a.message&&a.action_id){if("warning"===a.type){var c=this.get(a.action_id);a.message=a.message.replace("%d",Number(c.get("count"))-Number(c.get("done")))}b("#"+a.action_id+" .buddydrive-progress").html(a.message).addClass(a.type)}else b(".dashboard_page_buddydrive-upgrade #message").html("<p>"+a.message+"</p>").removeClass("buddydrive-hide updated").addClass("error")},injectTask:function(a){this.views.add("#buddydrive-tasks",new buddydrive.Views.Task({model:a}))},manageQueue:function(a){!0===a.get("active")&&this.collection.proceed({data:_.pick(a.attributes,["id","count","done"]),success:this.taskSuccess,error:this.taskError})}}),buddydrive.Views.Task=buddydrive.View.extend({tagName:"li",template:buddydrive.template("progress-window"),className:"buddydrive-task",initialize:function(){this.model.on("change:done",this.taskProgress,this),this.model.on("change:active",this.addClass,this),0===this.model.get("order")&&this.model.set("active",!0)},addClass:function(a){!0===a.get("active")&&b(this.$el).addClass("active")},taskProgress:function(a){if(!_.isUndefined(a.get("done"))&&!_.isUndefined(a.get("count"))){var c=Number(a.get("done"))/Number(a.get("count"))*100;b("#"+a.get("id")+" .buddydrive-progress .buddydrive-bar").css("width",c+"%")}}}),buddydrive.Upgrader.start())}(buddydrive,jQuery);